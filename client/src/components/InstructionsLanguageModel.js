import React from 'react';
import {getRndInteger} from '../utils/utilityFunctions';

class InstructionsLM extends React.Component {
    constructor(props) {
        super(props); 
        this.state = {cachedQuotes: null}
        this._fetchQuoteAndDisplay = this._fetchQuoteAndDisplay.bind(this); 
        this._addQuote = this._addQuote.bind(this); 
    }
    
    componentDidMount() {
        this._fetchQuoteAndDisplay(); 
    }

    /**
     * This method is the event handler for when the get new quote button is clicked by the user.
     * The rationale behind adding this extra wrapper method is for performance reasons. We don't need
     * to keep requesting data from the API and getting quotes if they are already present in our state storage.
     * So whenever we do request data from the API, when we recieve the response, we can cache values in storage. 
     */
    _addQuote() {
        if (this.state.cachedQuotes === null) {
            this._fetchQuoteAndDisplay();
        }

        else {
            this._addQuoteToPage(this.state.cachedQuotes); 
        }
    }

    async _fetchQuoteAndDisplay() {
        const quoteBox = document.getElementById("quoteBox");
        try {
            this.props._hideDisplays( 
                document.getElementById("quoteDisplay"),  
                document.getElementById("authorDisplay"),
                document.getElementById("newQuote")); 
            // add a spinning element to the div to indicate we are waiting on a response from an api
            // that will either succeed or fail, at which point spinnerDiv is removed 
            quoteBox.appendChild(this.props._addSpinnerAsync());
            const fetchedQuotesRaw = await fetch('https://type.fit/api/quotes');
            const fetchedQuotesJSON = await fetchedQuotesRaw.json(); 
            // cache the values we just got from the API in the storage 
            this.setState((state, props) => {
                return {cachedQuotes: fetchedQuotesJSON};
            });
            this._addQuoteToPage(this.state.cachedQuotes);
        }

        catch(err) {
            document.getElementById("quoteDisplay").innerHTML = "Sorry, there was an error fetching your quote :(";
        }
        finally {
            this.props._showDisplays( 
                document.getElementById("quoteDisplay"),  
                document.getElementById("authorDisplay"),
                document.getElementById("newQuote")); 
            quoteBox.removeChild(quoteBox.lastChild); 
        }
    }

    _addQuoteToPage(quotes) {
        this._cleanUpInnerHTML();
        const randomIdx = getRndInteger(0, 1643); 
        const randomQuote = quotes[randomIdx]; 
        this._addQuoteInfo(randomQuote); 
    }

    _cleanUpInnerHTML() {
        document.getElementById("quoteDisplay").innerHTML = null; 
        document.getElementById("authorDisplay").innerHTML = null; 
    }

    _addQuoteInfo(randomQuote) {
        const [quotePNode, authorPNode] = this._makeQuoteAuthorDisplay(randomQuote); 
        document.getElementById("quoteDisplay").appendChild(quotePNode); 
        document.getElementById("authorDisplay").appendChild(authorPNode);

    }

    _makeQuoteAuthorDisplay(randomQuote) {
        const authorPNode = document.createElement('p'); 
        const quotePNode = document.createElement('p'); 

        quotePNode.innerHTML = randomQuote.text; 
        authorPNode.innerHTML = "-"+(randomQuote.author ? randomQuote.author: "Unknown");
        return [quotePNode, authorPNode]; 
    }

    render() {
        return(
            <div className = "ML_Model_Instructions">
                <div id = "instructionsLM">
                    <p>
                        There are no special instructions for generating new pok√©mon names, just click on the
                        button below and a new name will be generated by an AI algorithm!
                    </p>
                    <p>
                        While generating names, enjoy the inspirational quotes below :) 
                    </p>
                </div>
                <div id = "quoteBox">
                    <div id = "quoteDisplay"></div>
                    <div id = "authorDisplay"></div>
                    <div id = "newQuote" className = "buttonSubmitModel" onClick = {this._addQuote}>Get New Quote</div>
                </div>
            </div>
        );
    }
}

export default InstructionsLM; 